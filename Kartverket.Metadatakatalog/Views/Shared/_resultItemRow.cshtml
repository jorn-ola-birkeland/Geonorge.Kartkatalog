@using Kartverket.Metadatakatalog.Helpers
@using Resources

@{var javaScriptSerializer = new System.Web.Script.Serialization.JavaScriptSerializer(); }

@Html.Partial("VueComponents/_ListRowButtons")
@Html.Partial("VueComponents/_TableRowButtons")

@Html.Partial("VueComponents/ResultItem/_Title")
@Html.Partial("VueComponents/ResultItem/_Owner")
@Html.Partial("VueComponents/ResultItem/_OpenData")
@Html.Partial("VueComponents/ResultItem/_DistributionType")
@Html.Partial("VueComponents/ResultItem/_DistributionUrl")
@Html.Partial("VueComponents/ResultItem/_DistributionFormats")
@Html.Partial("VueComponents/ResultItem/_Thumbnail")


<script type="text/x-template" id="resultItemRow">
    <div>

        @* *** TABELL *** *@
        <div v-if="$root.viewType == 'tableView'" class="resultItemRow table-border-bottom">
            <div class="result-item-row-content">
                <div class="row">
                    <div v-bind:class="getFieldSizeClass('title')" v-show="isSelectedField('title')" is="table-title" v-bind:metadata="resultItem" v-bind:parent-hierarchy-level="hierarchyLevel"></div>
                    <div v-bind:class="getFieldSizeClass('distributionType')" v-show="isSelectedField('distributionType')" is="table-distribution-type" v-bind:metadata="resultItem"></div>
                    <div v-bind:class="getFieldSizeClass('owner')" v-if="isSelectedField('owner')" is="table-owner" v-bind:metadata="resultItem"></div>
                    <div v-bind:class="getFieldSizeClass('openData')" v-if="isSelectedField('openData')" is="table-open-data" v-bind:metadata="resultItem"></div>
                    <div is="table-row-buttons" v-bind:metadata="resultItem" v-bind:listOfButtons="selectedButtons"></div>
                </div>
            </div>
        </div>

        @* **** LISTE **** *@
        <div v-if="$root.viewType == 'listView'" class="row resultItemRowList">
            <div class="col-sm-2">
                <div is="table-owner" v-bind:metadata="resultItem"></div>
            </div>
            <div class="col-sm-7">
                <div is="table-title" v-bind:metadata="resultItem"></div>
                <p>{{description}}</p>
                <div is="table-distributionType" v-bind:metadata="resultItem"></div>
                <div is="list-row-buttons" v-bind:metadata="resultItem" v-bind:listOfButtons="selectedButtons"></div>
            </div>
            <div class="col-sm-3">
                <div is="thumbnail" v-bind:metadata="resultItem"></div>
            </div>
            <div class="clearfix"></div>
        </div>

        @* *** GALLERI *** *@
        <div v-if="$root.viewType == 'galleryView'">
            <div is="table-title" v-bind:metadata="resultItem"></div>
        </div>

        <div v-if="$root.viewType != 'galleryView'" class="clearfix"></div>

    </div>
</script>


<script>
    //Component
    var ResultItemComponent = {
        template: "#resultItemRow",
        name: "resultItem",
        props: ["resultItem", "selectedFields", "selectedButtons"],
        data: function () {
            var data = {
                expanded: false,
                hierarchyLevel: this.$parent.hierarchyLevel !== undefined ? this.$parent.hierarchyLevel + 1 : 0,
            };
            return data;
        },
        components: {
            ListRowButtons: ListRowButtons,
            TableRowButtons: TableRowButtons,
            TableTitle: TableTitle,
            TableOwner: TableOwner,
            TableOpenData: TableOpenData,
            TableDistributionType: TableDistributionType,
            TableDistributionUrl: TableDistributionUrl,
            TableDistributionFormats: TableDistributionFormats,
            Buttons: Buttons,
            thumbnail: thumbnail
        },
        mounted: function () {
            var addToCartId = getParameterByName('addtocart_event_id');
            if (addToCartId && this.resultItem.Uuid == addToCartId) {
                this.addToCart();
                removeParameterByNameFromUrl('addtocart_event_id');
            }
        },
        created: function () {
        },
        computed: {
            addedToCart: function () {
                return this.getCartButtonStatus();
            },
            openData: function () {
                var openData = {
                    className: "",
                    title: ""
                };
                if (this.resultItem.IsRestricted) {
                    openData.className = "custom-icon custom-icon-hengelaas-closed-yellow";
                    openData.title = "@Html.Raw(UI.RestrictedData)";
                } else if (this.resultItem.IsOffline) {
                    openData.className = "custom-icon custom-icon-hengelaas-closed-red";
                    openData.title = "@Html.Raw(UI.OfflineData)";
                } else if (this.resultItem.IsOpendata) {
                    openData.className = "custom-icon custom-icon-hengelaas-open-green";
                    openData.title = "@Html.Raw(UI.OpenData)";
                }
                return openData;
            },
            mapLink: function () {
                var mapLink = {
                    mapLinkButtonId: "mapmacrolink-button-" + this.resultItem.Uuid,
                    mapMacroButtonId: "mapmacro-button-" + this.resultItem.Uuid,
                    mapLinkId: "mapmacrolink-" + this.resultItem.Uuid,
                    mapMacroId: "mapmacro-" + this.resultItem.Uuid,
                    onClick: "ga('send', 'event', 'Nedlasting', 'viskart')",
                    mapLinkClassButton: "btn btn-default",
                    mapLinkClassLink: "",
                    iconPermission: "custom-icon",
                    mapTitleTag: this.resultItem.MapTitleTag,
                    url: ""
                };

                if (this.resultItem.ShowMapLink) {
                    mapLink.iconPermission += " custom-icon-kartmarkoer";
                    mapLink.url = this.resultItem.MapUrl;

                } else if (this.resultItem.ShowServiceMapLink) {
                    mapLink.iconPermission += this.restrictedServiceClass();
                    mapLink.url = this.resultItem.ServiceUrl;
                } else {
                    mapLink.mapLinkClassLink = "disabled";
                    mapLink.mapLinkClassButton += " disabled";
                    mapLink.iconPermission += " custom-icon-kartmarkoer";
                    mapLink.mapLinkButtonId = "";
                    mapLink.mapMacroButtonId = "";
                    mapLink.mapLinkId = "";
                    mapLink.mapMacroId = "";
                    mapLink.onClick = "";
                    mapLink.mapTitleTag = "Vis " + this.resultItem.Title + " i kart";
                }
                return mapLink;
            },
            itemAddToCart: function () {
                var itemAddToCart = {
                    buttonClass: "btn btn-default add-to-cart-btn",
                };

                if (this.resultItem.IsRestricted || this.resultItem.IsOffline) {
                    itemAddToCart.buttonClass += " add-to-cart-btn prevent-action";
                }
                if (this.resultItem.IsRestricted) {
                    @{
                        string baseUrl = Request.Url.AbsoluteUri;
                        baseUrl = baseUrl.Replace("http://", "https://");
                        if (baseUrl.Contains("addtocart_event_id"))
                        {
                            baseUrl = HtmlHelperExtensions.RemoveQueryStringByKey(baseUrl, "addtocart_event_id");
                        }
                    }
                    var baseUrl = '@baseUrl';
                    var addToCartEventParamater = "?addtocart_event_id=" + this.resultItem.Uuid;

                    if (baseUrl.indexOf("?") !== -1) {
                        addToCartEventParamater = "&addtocart_event_id=" + this.resultItem.Uuid;
                    }

                    var downloadSignInUrl = '@Html.DownloadUrl()'
                   + 'AuthServices/SignIn?ReturnUrl='
                   + encodeURIComponent(baseUrl)
                   + encodeURIComponent(addToCartEventParamater);

                    var addToCartUrl = '@Html.KartkatalogenUrl()'
                         + 'AuthServices/SignIn?ReturnUrl='
                         + encodeURIComponent(downloadSignInUrl);
                    itemAddToCart.href = addToCartUrl;
                }
                return itemAddToCart;
            },
            organizationUrl: function () {
                url = "/etatvis-oversikt/" + this.resultItem.OrganizationSeoName;
                return url;
            },
            readMoreUrl: function () {
                var organization = this.resultItem.OrganizationSeoName;
                var title = this.resultItem.TitleSeo;
                var uuid = this.resultItem.Uuid;
                var url = "/metadata/" + organization + "/" + title + "/" + uuid;
                return url;
            },
            description: function () {
                var description;
                if (this.resultItem.Abstract.length > 250) {
                    description = this.resultItem.Abstract.substring(0, 251) + " ...";
                } else {
                    description = this.resultItem.Abstract;
                }
                return description;
            }
        },
        methods: {
            isSelectedField: function (fieldName) {
                var isSelected = false;
                this.selectedFields.forEach(function (selectedField) {
                    if (selectedField.name == fieldName) isSelected = true;
                });
                return isSelected;
            },
            getFieldSizeClass: function (fieldName) {
                var fieldSizeClass = "";
                this.selectedFields.forEach(function (selectedField) {
                    if (selectedField.name == fieldName) fieldSizeClass = "col-sm-" + selectedField.size;
                });
                return fieldSizeClass;
            },
            isSelectedButton: function (buttonName) {
                var isSelected = false;
                this.selectedButtons.forEach(function (selectedButtonName) {
                    if (selectedButtonName == buttonName) isSelected = true;
                });
                return isSelected;
            }
        }
    }
</script>
