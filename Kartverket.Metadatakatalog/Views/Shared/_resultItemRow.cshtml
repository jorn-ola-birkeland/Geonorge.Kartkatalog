@using Kartverket.Metadatakatalog.Helpers

@{var javaScriptSerializer = new System.Web.Script.Serialization.JavaScriptSerializer(); }

@Html.Partial("VueComponents/_TableRowButtons")

@Html.Partial("VueComponents/ResultItem/_Title")
@Html.Partial("VueComponents/ResultItem/_Owner")
@Html.Partial("VueComponents/ResultItem/_OpenData")
@Html.Partial("VueComponents/ResultItem/_DistributionType")
@Html.Partial("VueComponents/ResultItem/_DistributionUrl")
@Html.Partial("VueComponents/ResultItem/_DistributionFormats")
@Html.Partial("VueComponents/ResultItem/_CopyUrl")
@Html.Partial("VueComponents/ResultItem/_Thumbnail")


<script type="text/x-template" id="resultItemRow">
    <div>

        @* *** TABELL *** *@
        <div v-if="$root.viewType == 'tableView'" class="resultItemRow table-border-bottom">
            <div class="result-item-row-content">
                <div class="row">
                    <div v-bind:class="getFieldSizeClass('title')" v-show="isSelectedField('title')" is="table-title" v-bind:metadata="resultItem" v-bind:parent-hierarchy-level="hierarchyLevel"></div>
                    <div v-bind:class="getFieldSizeClass('distributionType')" v-show="isSelectedField('distributionType')" is="table-distribution-type" v-bind:metadata="resultItem"></div>
                    <div v-bind:class="getFieldSizeClass('owner')" v-if="isSelectedField('owner')" is="table-owner" v-bind:metadata="resultItem"></div>
                    <div v-bind:class="getFieldSizeClass('openData')" v-if="isSelectedField('openData')" is="table-open-data" v-bind:metadata="resultItem"></div>
                    <div v-bind:class="getFieldSizeClass('copyUrl')" v-if="isSelectedField('copyUrl')" is="table-copy-url" v-bind:metadata="resultItem"></div>
                    <div is="table-row-buttons" v-bind:metadata="resultItem" v-bind:listOfButtons="selectedButtons"></div>
                </div>
            </div>
        </div>

        @* **** LISTE **** *@
        <div v-if="$root.viewType == 'listView'" class="row resultItemRowList">
            <div class="col-sm-1">
                <div is="table-owner" v-bind:metadata="resultItem"></div>
            </div>
            <div class="col-sm-6">
                <div is="table-title" v-bind:metadata="resultItem"></div>
                <p>{{description}}</p>
                <div is="table-distributionType" v-bind:metadata="resultItem"></div>
            </div>
            <div class="col-sm-2">
                <div is="buttons" v-bind:result-item="resultItem" v-bind:selectedButtons="['showInMapButton']" v-bind:buttonType="'button'"></div>
                <div is="buttons" v-bind:result-item="resultItem" v-bind:selectedButtons="['addToCartButton']" v-bind:buttonType="'button'"></div>
            </div>
            <div class="col-sm-3">
                <div is="thumbnail" v-bind:metadata="resultItem"></div>
            </div>
            <div class="clearfix"></div>
        </div>

        @* *** GALLERI *** *@
        <div v-if="$root.viewType == 'galleryView'">
            <div is="table-title" v-bind:metadata="resultItem"></div>
        </div>

        <div v-if="$root.viewType != 'galleryView'" class="clearfix"></div>

    </div>
</script>


<script>
    //Component
    var ResultItemComponent = {
        template: "#resultItemRow",
        name: "resultItem",
        props: ["resultItem", "selectedFields", "selectedButtons"],
        data: function () {
            var data = {
                expanded: false,
                addedToCart: false,
                hierarchyLevel: this.$parent.hierarchyLevel !== undefined ? this.$parent.hierarchyLevel + 1 : 0,
            };
            return data;
        },
        components: {
            TableRowButtons: TableRowButtons,
            TableTitle: TableTitle,
            TableOwner: TableOwner,
            TableOpenData: TableOpenData,
            TableDistributionType: TableDistributionType,
            TableDistributionUrl: TableDistributionUrl,
            TableDistributionFormats: TableDistributionFormats,
            TableCopyUrl: TableCopyUrl,
            Buttons: Buttons,
            thumbnail: thumbnail
        },
        mounted: function () {
            this.getCartButtonStatus();
            var addToCartId = getParameterByName('addtocart_event_id');
            if (addToCartId && this.resultItem.Uuid == addToCartId) {
                this.addToCart();
                removeParameterByNameFromUrl('addtocart_event_id');
            }
        },
        computed: {
            readMoreUrl: function () {
                var organization = this.resultItem.OrganizationSeoName;
                var title = this.resultItem.TitleSeo;
                var uuid = this.resultItem.Uuid;
                var url = "/metadata/" + organization + "/" + title + "/" + uuid;
                return url;
            },

            // TODO ta vekk
            organizationUrl: function () {
                url = "/etatvis-oversikt/" + this.resultItem.OrganizationSeoName;
                return url;
            },
            description: function () {
                var description;
                if (this.resultItem.Abstract.length > 250) {
                    description = this.resultItem.Abstract.substring(0, 251) + " ...";
                } else {
                    description = this.resultItem.Abstract;
                }
                return description;
            }
        },
        methods: {
            isSelectedField: function (fieldName) {
                var isSelected = false;
                this.selectedFields.forEach(function (selectedField) {
                    if (selectedField.name == fieldName) isSelected = true;
                });
                return isSelected;
            },
            getFieldSizeClass: function (fieldName) {
                var fieldSizeClass = "";
                this.selectedFields.forEach(function (selectedField) {
                    if (selectedField.name == fieldName) fieldSizeClass = "col-sm-" + selectedField.size;
                });
                return fieldSizeClass;
            },
            isSelectedButton: function (buttonName) {
                var isSelected = false;
                this.selectedButtons.forEach(function (selectedButtonName) {
                    if (selectedButtonName == buttonName) isSelected = true;
                });
                return isSelected;
            }
        }
    }
</script>
