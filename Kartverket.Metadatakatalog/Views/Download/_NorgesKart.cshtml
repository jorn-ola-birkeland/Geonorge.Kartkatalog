@using Kartverket.Metadatakatalog.Helpers

<script>
    var CLIPPERCOORDS;
    var fixedCoordinates = false;
    var areatype = "";
    var mapSelectionLayer = "";
    var canDownload = true;


    function sendMessage(msg) {
        var win = document.getElementById("iframe").contentWindow;
        win.postMessage(JSON.stringify(msg), '*');
    }

    function loadMap(orderItem) {
        var id = orderItem.metadata.uuid;
        var fixed = orderItem.capabilities.supportsGridSelection;
        var typeOfArea = orderItem.codelists.areaTypes[0].name;
        var mapselectionlayer = orderItem.capabilities.mapSelectionLayer;
        if (fixed) {
            fixedCoordinates = true;
            areatype = typeOfArea;
            mapSelectionLayer = mapselectionlayer;
            loadMapFixed(id);
            return;
        }

        fixedCoordinates = false;

        var coverageParams = "";
        $.ajax({
            url: '/api/getdata/' + id + '',
            type: "GET",
            async: false,
            success: function (result) {
                coverageParams = result.CoverageUrl;
                if (typeof coverageParams == 'undefined')
                    coverageParams = '';
            }
        });

        conf = {
            center_latitude: "7226208",
            center_longitude: "378604",
            grid_folder: "/sites/all/modules/custom/kms_widget/grid/",
            koordinatsystem: "UTM32-EUREF89",
            selection_type: "3525",
            service_name: "fylker-utm32",
            zoom_level: "4",
        };

        window.addEventListener('message', function (e) {
            $("#setcoordinates").attr("disabled", true);
            var msg = JSON.parse(e.data);
            if (msg.type === "mapInitialized") {
                sendMessage({
                    "cmd": "setCenter",
                    "x": conf.center_longitude,
                    "y": conf.center_latitude,
                    "zoom": conf.zoom_level
                });
            } else {


                if (msg.cmd === "setVisible") return;

                var obj = msg;
                var reslist = document.getElementById('result');
                if (obj.feature != null) {
                    CLIPPERCOORDS = obj.feature.geometry.coordinates.toString();
                    CLIPPERCOORDS = CLIPPERCOORDS.replace(/,/g, " ");
                    var defaultCoordinatesystem = "32633";
                    var canDownload = {
                        "metadataUuid": orderItem.metadata.uuid,
                        "coordinates": CLIPPERCOORDS,
                        "coordinateSystem": defaultCoordinatesystem
                    };

                    var urlCanDownload = (orderItem.metadata.canDownloadUrl !== undefined) ? orderItem.metadata.canDownloadUrl : false;
                    if (urlCanDownload) {

                        $.ajax({
                            url: urlCanDownload,
                            type: "POST",
                            dataType: 'json',
                            data: JSON.stringify(canDownload),
                            contentType: "application/json",
                            async: true,
                            error: function (jqXHR, textStatus, errorThrown) {
                                //Ignore error
                            },
                            beforeSend: function () {
                                showLoadingAnimation("Sjekker størrelse for valgt område");
                            },
                            success: function (data) {
                                if (data !== null) {
                                    if (!data.canDownload) {
                                        canDownload = false;
                                        clearAlertMessage();
                                        showAlert("Området er for stort til å laste ned, vennligst velg mindre område", "danger");
                                    } else {
                                        $("#setcoordinates").attr("disabled", false);
                                    }
                                }
                                hideLoadingAnimation();
                            },
                        });
                    }

                    if (canDownload) {


                        $("#setcoordinates").click(function () {
                            orderItem.codelists.selectedProjections = [];
                            orderItem.codelists.availableProjections = orderItem.codelists.projections;
                            orderItem.codelists.selectedFormats = [];
                            orderItem.codelists.availableFormats = orderItem.codelists.formats;

                            var polygonIsSelected = false;
                            orderItem.codelists.selectedAreas.forEach(function (selectedArea) {
                                if (selectedArea.type == "polygon") polygonIsSelected = true;
                            });

                            if (!polygonIsSelected) {
                                orderItem.codelists.selectedAreas.push(
                                    {
                                        "name": "Valgt fra kart",
                                        "type": "polygon",
                                        "code": "Kart",
                                        "formats": orderItem.codelists.formats,
                                        "projections": orderItem.codelists.projections
                                    }
                                );
                            }

                            var containsPolygonArea = false;
                            orderItem.codelists.areas.forEach(function (area, val) {
                                if (area.type == "polygon") {
                                    containsPolygonArea = true;
                                }
                            });

                            if (!containsPolygonArea) {
                                var inAreaTypeArray = false;
                                orderItem.codelists.areaTypes.forEach(function (areaType) {
                                    if (areaType.name == "polygon") {
                                        inAreaTypeArray = true;
                                        areaType.numberOfItems = 1;
                                    }
                                });
                                if (!inArray) {
                                    orderItem.codelists.areaTypes.push({
                                        name: "polygon",
                                        numberOfItems: 1
                                    });
                                }
                            }

                            orderItem.codelists.coordinates = CLIPPERCOORDS;
                            orderItem.codelists.coordinatesystem = defaultCoordinatesystem;
                        });
                    }
                }
            }
        }, false);

        $("#container").html("<iframe src='@Html.SecureNorgeskartUrl()select.html" + coverageParams + "' id='iframe' name='iframe'></iframe>");
    };


    function loadMapFixed(metadataUuid) {
        var areas = {};
        conf = { "service_name": mapSelectionLayer, "center_longitude": "378604", "center_latitude": "7226208", "zoom_level": "3" }

        window.addEventListener('message', function (e) {
            var msg = JSON.parse(e.data);
            console.log("Event");
            if (msg.type === "mapInitialized") {
                sendMessage({
                    "cmd": "setCenter",
                    "x": conf.center_longitude,
                    "y": conf.center_latitude,
                    "zoom": conf.zoom_level
                });
                sendMessage({
                    "cmd": "setVisible",
                    "id": conf.service_name
                });
            } else {
                if (msg.cmd === "setVisible") return;
                var obj = msg;
                if (isJson(msg)) {
                    var data = JSON.parse(msg);
                    if (data["type"] == "mapInitialized") return;

                    var name = data["attributes"]["n"];
                    var areaname;
                    areaname = name;

                    var path = areaname;

                    if (data["cmd"] == "featureSelected") {
                        areas[path] = areaname;
                    }
                    if (data["cmd"] == "featureUnselected") {
                        delete areas[path];
                    }
                }
            }
            var selectedAreas = [];
            for (area in areas) {
                selectedAreas.push(area);
            };
            var availableProjections = [];
            var availableFormats = [];
            orderItem.codelists.areas.forEach(function (area, val) {
                if ($.inArray(area.code, selectedAreas) !== -1) {
                    area.selected = true;
                    if (area.projections !== undefined) {
                        availableProjections = getAvailableProjections(area.projections, availableProjections);
                    }
                    if (area.formats !== undefined) {
                        availableFormats = getAvailableProjections(area.formats, availableFormats);
                    }
                } else {
                    area.selected = false;
                }
            });
            orderItem.codelists.availableProjections = availableProjections;
            orderItem.codelists.availableFormats = availableFormats;
        }, false);

        $("#container").html("<iframe src='@Html.SecureNorgeskartUrl()nedlasting.html#" + conf.zoom_level + "/" + conf.center_longitude + "/" + conf.center_latitude + "/+" + conf.service_name + "' id='iframe' name='iframe'></iframe>");

    }

    function isJson(str) {
        try {
            JSON.parse(str);
        } catch (e) {
            return false;
        }
        return true;
    }

    function resizeIframe(iframe) {
        var windowHeight = $(window).height();
        var iframeHeight = windowHeight - 125;
        iframe.height(iframeHeight);
    }
</script>
