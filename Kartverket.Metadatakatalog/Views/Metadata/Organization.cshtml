@using Kartverket.Metadatakatalog.Models.ViewModels
@using Kartverket.Metadatakatalog.Helpers
@model SearchByOrganizationViewModel

@{
    ViewBag.Title = "Etatsvis oversikt over data";
}

@section breadcrumb {
    <li class="active">@Model.OrganizationName</li>
}

<div id="feedback-alert" class="alert alert-success alert-dismissible" role="alert">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    <span class="message"></span>
</div>

<section class="heading">
    <div class="row">
        <div class="col-sm-12">
            <h1 class="small-h1">
                @ViewBag.Title
            </h1>
        </div>
        <div class="col-sm-12">
            <span class="separator-lg"></span>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-3">
            <form id="organizationDD" action="@Url.Action("Organization", "Metadata", new { OrganizationSeoName = "" })" name="FilterForm" method="get" class="custom-select">
                @Html.DropDownList("OrganizationSeoName", Model.OrganizationSelectList, "Velg etat", new { @class = "form-control" })
            </form>
        </div>
    </div>
</section>

@Html.Partial("_resultItemRow")
@Html.Partial("_searchResult")

<script type="text/x-template" id="resultItemRow">
    <div>
        @* **** LISTE **** *@
        <div v-if="$root.viewType == 'listView'" class="row resultItemRowList">
            <div class="col-sm-1">
                <div is="table-owner" v-bind:metadata="resultItem"></div>
            </div>
            <div class="col-sm-6">
                <div is="table-title" v-bind:metadata="resultItem"></div>
                <p>{{description}}</p>
                <div is="table-distributionType" v-bind:metadata="resultItem"></div> 
            </div>
            <div class="col-sm-2">
                <div is="buttons" v-bind:result-item="resultItem" v-bind:selectedButtons="['showInMapButton']" v-bind:buttonType="'button'"></div>
                <div is="buttons" v-bind:result-item="resultItem" v-bind:selectedButtons="['addToCartButton']" v-bind:buttonType="'button'"></div>
            </div>
            <div class="col-sm-3">
                <div is="thumbnail" v-bind:metadata="resultItem"></div>
            </div>
            <div class="clearfix"></div>
        </div>

        @* *** TABELL *** *@
        <div v-if="$root.viewType == 'tableView'">
            <div class="resultItemRow">
                <div class="row">
                    <div class="col-sm-4">
                        <div is="table-title" v-bind:metadata="resultItem"></div>
                    </div>
                    <div class="col-sm-2">
                        <div is="table-distribution-type" v-bind:metadata="resultItem"></div>
                    </div>
                    <div class="col-sm-3">
                        <div is="table-owner" v-bind:metadata="resultItem"></div>
                    </div>
                    <div class="col-sm-1">
                        <div is="table-open-data" v-bind:metadata="resultItem"></div>
                    </div>
                    <div class="col-xs-1">
                        <div is="table-row-buttons" v-bind:metadata="resultItem" v-bind:listOfButtons="['showInMapButton']"></div>
                    </div>
                    <div class="col-xs-1">
                        <div is="table-row-buttons" v-bind:metadata="resultItem" v-bind:listOfButtons="['addToCartButton']"></div>
                    </div>
                </div>
            </div>
        </div>

        @* *** GALLERI *** *@
        <div v-if="$root.viewType == 'galleryView'">
            <div is="table-title" v-bind:metadata="resultItem"></div>
        </div>

        <div v-if="$root.viewType != 'galleryView'" class="clearfix"></div>
    </div>
</script>

<script type="text/x-template" id="searchResultTemplate">
    <div>
        <div v-if="$root.viewType == 'tableView' && items.length" class="row resultItemRowTableHeader">
            <div class="col-sm-4" is="header-title"></div>
            <div class="col-sm-2" is="header-type"></div>
            <div class="col-sm-3" is="header-organization"></div>
            <div class="col-sm-1" is="header-open-data"></div>
            <div class="col-sm-1" is="header-map"></div>
            <div class="col-sm-1" is="header-add-to-cart"></div>
        </div>

        <div v-if="$root.viewType == 'tableView'" class="menu-separator search-results-table-heading"></div>
        <div v-for="item in items" v-bind:class="tableBorder">
            <div is="resultItem" v-bind:result-item="item"></div>
        </div>

        <div class="clearfix"></div>
    </div>
</script>

@helper DisplayPaginationBottom()
{
    <div class="search-result-navigation">
        Viser @Model.ShowingFromAndTo() av @Model.NumFound treff:
        <div class="pagination-container">
            <ul class="pagination pagination-sm btn-group inline-block">
                @if (Model.IsFirstButtonActive())
                {
                    <li><a aria-label="Første" title="Første" href="@Url.Action("Organization", Model.OrganizationRouteValues(Model.ParamsForFirstLink()))">&laquo;</a></li>
                }

                @if (Model.IsPreviousButtonActive())
                {
                    <li><a href="@Url.Action("Organization", Model.OrganizationRouteValues(Model.ParamsForPreviousLink()))">&laquo; Forrige</a></li>
                }

                @for (int i = Model.startPage; i <= Model.endPage; i++)
                {
                    if (Model.IsActivePage(i))
                    {
                        <li class="active"><a href="@Url.Action("Organization", Model.OrganizationRouteValues(Model.ParamsForPageNumber(i)))">@i</a></li>
                    }
                    else
                    {
                        <li><a href="@Url.Action("Organization", Model.OrganizationRouteValues(Model.OrganizationRouteValues(Model.ParamsForPageNumber(i))))">@i</a></li>
                    }
                }

                @if (Model.IsNextButtonActive())
                {
                    <li><a href="@Url.Action("Organization", Model.OrganizationRouteValues(Model.ParamsForNextLink()))">Neste &raquo;</a></li>
                }
                @if (Model.IsLastButtonActive())
                {
                    <li><a aria-label="Siste" title="Siste" href="@Url.Action("Organization", Model.OrganizationRouteValues(Model.ParamsForLastLink()))"> &raquo;</a></li>
                }
            </ul>
        </div>
    </div>
}

@{
    string url = HttpContext.Current.Request.Url.AbsoluteUri;
    if (url.Contains("etatvis-oversikt/organisasjon"))
    {
        url = url.Replace("etatvis-oversikt/organisasjon", "api/search");
    }
    else if (url.Contains("etatvis-oversikt"))
    {
        url = url.Replace("etatvis-oversikt/" + Model.OrganizationSeoName, "api/search");
    }
    else
    {
        url = url.Replace("metadata/" + Model.OrganizationSeoName, "api/search");
    }
    Uri uri = new Uri(url);
    string path = String.Format("{0}{1}{2}{3}", uri.Scheme,
    Uri.SchemeDelimiter, uri.Authority, uri.AbsolutePath);
    var qs = HttpUtility.ParseQueryString("");

    for (int f = 0; f < Model.FacetParameters.Count; f++)
    {
        var facet = Model.FacetParameters[f];

        qs.Add("facets[" + f + "]name", facet.Name);
        qs.Add("facets[" + f + "]value", facet.Value);
    }
    qs.Set("Offset", "1"); qs.Set("limit", Model.NumFound.ToString()); qs.Add("mediatype", "csv");
    string query = qs.ToString(); string urlCSV = path + "?" + query;
}


<div class="row search-result-navigation">
    <div class="col-md-4">
        Viser @Model.ShowingFromAndTo() av @Model.NumFound treff:
        <div class="pagination-container">
            <ul class="pagination pagination-sm btn-group inline-block">
                @if (Model.IsFirstButtonActive())
            {
                    <li><a aria-label="Første" title="Første" href="@Url.Action("Organization", Model.OrganizationRouteValues(Model.ParamsForFirstLink()))"><span class="fa fa-angle-double-left"></span></a></li>
                }

                @if (Model.IsPreviousButtonActive())
            {
                    <li><a href="@Url.Action("Organization", Model.OrganizationRouteValues(Model.ParamsForPreviousLink()))"><span class="fa fa-angle-left"></span> Forrige</a></li>
                }

                @for (int i = Model.startPage; i <= Model.endPage; i++)
            {
                if (Model.IsActivePage(i))
                {
                        <li class="active"><a href="@Url.Action("Organization", Model.OrganizationRouteValues(Model.ParamsForPageNumber(i)))">@i</a></li>
                    }
                    else
                    {
                        <li><a href="@Url.Action("Organization", Model.OrganizationRouteValues(Model.ParamsForPageNumber(i)))">@i</a></li>
                    }
                }

                @if (Model.IsNextButtonActive())
            {
                    <li><a href="@Url.Action("Organization", Model.OrganizationRouteValues(Model.ParamsForNextLink()))"> Neste <span class="fa fa-angle-right"></span></a></li>
                }
                @if (Model.IsLastButtonActive())
            {
                    <li><a aria-label="Siste" title="Siste" href="@Url.Action("Organization", Model.OrganizationRouteValues(Model.ParamsForLastLink()))"> <span class="fa fa-angle-double-right"></span></a></li>
                }
            </ul>
        </div>
    </div>
    <div class="col-md-4 pull-right">
        <div class="save-as-menu pull-right">
            <label>Lagre som:</label>
            <div class="no-padding-bottom save-as-dropdown">
                <div class="custom-select">
                    <select onchange="additionalView(this.value)" class="form-control">
                        <option value="csvUrl" selected="selected">CSV</option>
                    </select>
                </div>
            </div>
            <div id="saveButtons" class="no-padding-bottom save-as-buttons">
                <a class="btn" id="csvUrl" href="@urlCSV">Lagre</a>
            </div>
        </div>
    </div>
    <div class="clearfix"></div>

</div>

<span class="separator-small separator-gray margin-bottom-10"></span>


<div class="row resultItemTitleRow">

    <div id="searchResultTable" class="col-md-9">
        <span v-on:click="view('galleryView')" class="pull-right fa fa-th-large"></span>
        <span v-on:click="view('listView')" class="pull-right fa fa-list"></span>
        <span v-on:click="view('tableView')" class="pull-right fa fa-table"></span>
        <div class="clearfix"></div>
        
        <div is="searchResult" v-bind:result-items="ResultItems"></div>

        @DisplayPaginationBottom()

        
    </div>
    <div class="col-sm-12 col-md-3 pull-left hidden-sm hidden-xs">
        <aside class="facet-filter-container">
            <h3 class="">Filtrer søket på:</h3>
            <span class="separator-small"></span>
            @Html.Partial("_FacetFilter", Model)

            <h3 class="" style="padding-top: 40px;">Sider</h3>
            <span class="separator-small"></span>
            @Html.Partial("_FilterPages")
        </aside>
    </div>
</div>



@section scripts {
    @{ var javaScriptSerializer = new System.Web.Script.Serialization.JavaScriptSerializer(); }

    <script>

        // Setter url for søkeresultat
        @if (Model.OrganizationSeoName != null) {
            @:setMainSearchUrl('etatvis-oversikt/@Model.OrganizationSeoName');
            @:setMainSearchApiUrl('search?facets[0]name=organization&facets[0]value=@Model.OrganizationName');
        }
        else
        {
            @:setMainSearchUrl('etatvis-oversikt/organisasjon');
        }

        //Main vue model
        var vueModel = new Vue({
            el: '#searchResultTable',
            data: {
                ResultItems: @Html.Raw(HttpUtility.HtmlDecode(javaScriptSerializer.Serialize(Model.Result.Items))),
                viewType: "tableView"
            },
            components: {
                SearchResult: SearchResult,
                ResultItem: ResultItemComponent
            },
            created: function() {
                this.viewType = this.getSelectedViewType();
            },
            methods: {
                view: function(type) {
                    this.viewType = type;
                    localStorage.setItem("layout", this.viewType);
                    if (type === "galleryView") {
                        this.tableBorder = "";
                    } else {
                        this.tableBorder = "table-border-bottom";
                    }
                },
                getSelectedViewType: function() {
                    var viewType = "tableView";
                    if (localStorage.getItem("layout")) {
                        viewType = localStorage.getItem("layout");
                        this.view(viewType);
                    }
                    return viewType;
                }
            }
        });
    </script>

    <script>
        function showAlert(message, colorClass) {
            $('#feedback-alert').attr('class', 'alert alert-dismissible alert-' + colorClass);
            $('#feedback-alert .message').html(message);
            $('#feedback-alert').show();
        }

        $(document).ready(function () {
            $("#OrganizationSeoName").change(
                function () {
                    this.form.submit();
                    location.href = $(this).val();
                }
            );

        });

        $(document).ready(function () {
            @if (Html.DownloadServiceEnabled())
            {
            <text>
            if (localStorage.getItem("orderItems") != null) {
                var storedOrderItems = JSON.parse(localStorage["orderItems"]);
                var orderitemCount = storedOrderItems.length;
                if (orderitemCount > 0) {
                    $('#orderitem-count').text(orderitemCount);
                    $('#orderitem-count-text').text(' datasett');
                    updateAllCartButtons(storedOrderItems);
                } else {
                    $('#orderitem-count').text('');
                    $('#orderitem-count-text').text('Kurven er tom');
                }
            } else {
                $('#orderitem-count').text('');
                $('#orderitem-count-text').text('Kurven er tom');
            }
            </text>
            }
        });
    </script>
}
