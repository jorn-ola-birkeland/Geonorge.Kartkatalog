@using Kartverket.Metadatakatalog.Models.ViewModels
@using Resources
@using Kartverket.Metadatakatalog.Helpers
@using System;
@model SearchViewModel

@{
    if (!string.IsNullOrWhiteSpace(Model.Text))
    {
        ViewBag.Title = "Søk etter " + Model.Text;
    }
    else
    {
        ViewBag.Title = "Søk";
    }
}

<div id="feedback-alert" class="alert alert-success alert-dismissible" role="alert">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    <span class="message"></span>
</div>
<section class="heading">
    <div class="row">
        <div class="col-sm-12">
            <h1 class="small-h1">
                Tjenestekatalogen
            </h1>
        </div>
        <div class="col-sm-12">
            <span class="separator-lg"></span>
        </div>
    </div>
</section>

@helper DisplayPaginationBottom()
{
    <div class="search-result-navigation">
        Viser @Model.ShowingFromAndTo() av @Model.NumFound treff:
        <div class="pagination-container">
            <ul class="pagination pagination-sm btn-group inline-block">
                @if (Model.IsFirstButtonActive())
                {
                    <li><a aria-label="Første" title="Første" href="@Url.Action("Index", Model.ParamsForFirstLink())">&laquo;</a></li>
                }

                @if (Model.IsPreviousButtonActive())
                {
                    <li><a href="@Url.Action("Index", Model.ParamsForPreviousLink())">&laquo; Forrige</a></li>
                }

                @for (int i = Model.startPage; i <= Model.endPage; i++)
                {
                    if (Model.IsActivePage(i))
                    {
                        <li class="active"><a href="@Url.Action("Index", Model.ParamsForPageNumber(i))">@i</a></li>
                    }
                    else
                    {
                        <li><a href="@Url.Action("Index", Model.ParamsForPageNumber(i))">@i</a></li>
                    }
                }

                @if (Model.IsNextButtonActive())
                {
                    <li><a href="@Url.Action("Index", Model.ParamsForNextLink())">Neste &raquo;</a></li>
                }
                @if (Model.IsLastButtonActive())
                {
                    <li><a aria-label="Siste" title="Siste" href="@Url.Action("Index", Model.ParamsForLastLink())"> &raquo;</a></li>
                }
            </ul>
        </div>
    </div>
}



@section scripts {
    <script>
        function showAlert(message, colorClass) {
            $('#feedback-alert').attr('class', 'alert alert-dismissible alert-' + colorClass);
            $('#feedback-alert .message').html(message);
            $('#feedback-alert').show();
        }
        $(document).ready(function () {
            $("#orderby").change(
                 function () {
                     location.href = $(this).val();
                 }
             );
        });


        $(document).ready(function () {
            @if (Html.DownloadServiceEnabled())
            {
            <text>
            if (localStorage.getItem("orderItems") != null) {
                var storedOrderItems = JSON.parse(localStorage["orderItems"]);
                var orderitemCount = storedOrderItems.length;
                if (orderitemCount > 0) {
                    $('#orderitem-count').text(orderitemCount);
                    $('#orderitem-count-text').text(' datasett');
                    updateAllCartButtons(storedOrderItems);
                } else {
                    $('#orderitem-count').text('');
                    $('#orderitem-count-text').text('Kurven er tom');
                }
            } else {
                $('#orderitem-count').text('');
                $('#orderitem-count-text').text('Kurven er tom');
            }
            </text>
            }
        });


        $(window).load(function () {
            @if (Html.DownloadServiceEnabled())
            {
         <text>
            if (typeof Storage !== "undefined") {

                console.log('window.localStorage is available!');
                var orderItems = [];
                $('.add-to-cart-btn:not(.prevent-action)').click(function () {
                    addToCartButtonClick($(this));
                });
            } else {
                console.log('no native support for HTML5 storage :(');
            }

            </text>
            }

        });
    </script>
}

@*
    <article class="row">
        @Html.Partial("_SearchBarPartial", Model)
    </article>
*@

@{
    string url = HttpContext.Current.Request.Url.AbsoluteUri; url = url.ToLower().Replace("servicedirectory", "api/servicedirectory");
    Uri uri = new Uri(url);
    string path = String.Format("{0}{1}{2}{3}", uri.Scheme,
    Uri.SchemeDelimiter, uri.Authority, uri.AbsolutePath);
    string querystring = Request.QueryString.ToString();
    querystring = querystring.Replace(".name", "name"); querystring = querystring.Replace(".value", "value");
    var qs = HttpUtility.ParseQueryString(querystring);
    System.Collections.Specialized.NameValueCollection qsCol = new System.Collections.Specialized.NameValueCollection(qs);
    qs.Clear();
    foreach (string key in qsCol)
    {
        qs.Add(key.ToLower(), qsCol[key]);
    }
    qs.Set("Offset", "1"); qs.Set("limit", Model.NumFound.ToString()); qs.Add("mediatype", "csv");
    string query = qs.ToString(); string urlCSV = path + "?" + query;
}


<div class="row search-result-navigation">
    <div class="col-md-4">
        Viser @Model.ShowingFromAndTo() av @Model.NumFound treff:
        <div class="pagination-container">
            <ul class="pagination pagination-sm btn-group inline-block">
                @if (Model.IsFirstButtonActive())
                {
                    <li><a aria-label="Første" title="Første" href="@Url.Action("Index", Model.ParamsForFirstLink())"><span class="fa fa-angle-double-left"></span></a></li>
                }

                @if (Model.IsPreviousButtonActive())
                {
                    <li><a href="@Url.Action("Index", Model.ParamsForPreviousLink())"><span class="fa fa-angle-left"></span> </a></li>
                }

                @for (int i = Model.startPage; i <= Model.endPage; i++)
                {
                    if (Model.IsActivePage(i))
                    {
                        <li class="active"><a href="@Url.Action("Index", Model.ParamsForPageNumber(i))">@i</a></li>
                    }
                    else
                    {
                        <li><a href="@Url.Action("Index", Model.ParamsForPageNumber(i))">@i</a></li>
                    }
                }

                @if (Model.IsNextButtonActive())
                {
                    <li><a href="@Url.Action("Index", Model.ParamsForNextLink())">  <span class="fa fa-angle-right"></span></a></li>
                }
                @if (Model.IsLastButtonActive())
                {
                    <li><a aria-label="Siste" title="Siste" href="@Url.Action("Index", Model.ParamsForLastLink())"> <span class="fa fa-angle-double-right"></span></a></li>
                }
            </ul>
        </div>
    </div>
    <div class="col-md-4">
        <div class="save-as-menu">
            <label>Lagre som:</label>
            <div class="no-padding-bottom save-as-dropdown">
                <div class="custom-select">
                    <select onchange="additionalView(this.value)" class="form-control">
                        <option value="csvUrl" selected="selected">CSV</option>
                    </select>
                </div>
            </div>
            <div id="saveButtons" class="no-padding-bottom save-as-buttons">
                <a class="btn" id="csvUrl" href="@urlCSV">Lagre</a>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-md-offset-1">
        Velg visningsform:
        <div class="custom-select">
            <select id="layoutSelect" onchange="changeLayout(this.value)" class="form-control">
                <option value="tableView" id="button-tableView">Tabell</option>
                <option value="listView" id="button-listView">Liste</option>
                <option value="galleryView" id="button-galleryView">Galleri</option>
            </select>
        </div>
    </div>
    <div class="clearfix"></div>


</div>

<span class="separator-small separator-gray margin-bottom-10"></span>

<div class="row">
    <div class="col-md-12">

        @if (Model.Result != null)
        {
            <div id="tableView" class="search-results">
                <div class="row search-results-table-heading">
                    <div class="col-sm-4 orderby orderby-title orderby-asc" id="orderby-title-asc"><p><a href="@Url.Action("Index", Model.ParamsForOrderByTitleLink())" class="table-ordering show-loading-animation" data-loading-message="Sorterer innhold">Tittel<span class="orderby-indicator"></span></a></p></div>
                    <div class="col-sm-4 orderby orderby-title orderby-desc" id="orderby-title-desc"><p><a href="@Url.Action("Index", Model.ParamsForOrderByTitleDescLink())" class="table-ordering show-loading-animation" data-loading-message="Sorterer innhold">Tittel<span class="orderby-indicator"></span></a></p></div>

                    <div class="col-sm-2"><p>Type</p></div>

                    <div class="col-sm-3 orderby orderby-organization orderby-asc" id="orderby-organization-asc"><p><a href="@Url.Action("Index", Model.ParamsForOrderByOrganizationLink())" class="table-ordering show-loading-animation" data-loading-message="Sorterer innhold">Dataeier<span class="orderby-indicator"></span></a></p></div>
                    <div class="col-sm-3 orderby orderby-organization orderby-desc" id="orderby-organization-desc"><p><a href="@Url.Action("Index", Model.ParamsForOrderByOrganizationDescLink())" class="table-ordering show-loading-animation" data-loading-message="Sorterer innhold">Dataeier<span class="orderby-indicator"></span></a></p></div>
                    <div class="col-sm-1 no-padding text-center"><p>Åpne data</p></div>
                    <div class="col-sm-1 no-padding text-center"><p>URL til tjeneste</p></div>
                    <div class="col-sm-1 no-padding text-center"><p>Vis i kart</p></div>
                </div>
                <div class="menu-separator search-results-table-heading"></div>
                @foreach (var item in Model.Result.Items)
                {
                    <div class="row result-row metadata">

                        <div class="col-sm-1 search-results-logo">
                            @if (!string.IsNullOrWhiteSpace(item.OrganizationLogoUrl))
                            {
                                Uri organizationLogoUrl = new Uri(item.OrganizationLogoUrl);
                                string relativeOrganizationLogoUrl = "//" + organizationLogoUrl.Host + organizationLogoUrl.PathAndQuery;
                                <a href="@Url.Action("Organization", "Metadata", new { OrganizationSeoName = @item.OrganizationSeoName() })" class="show-loading-animation" data-loading-message="Henter innhold">
                                    <img src="@relativeOrganizationLogoUrl" class="img-responsive center-block" alt="Logo @item.Organization" title="Vis alle tjenester og datasett fra @item.Organization" />
                                </a>
                            }
                        </div>

                        <div class="col-sm-4 search-results-title">
                            <a href="@Url.Action("Index", "Metadata", item.ShowMetadataLinkRouteValueDictionary())" class="show-loading-animation" data-loading-message="Henter @item.GetInnholdstype().ToLower()">
                                <p class="role-button search-results-name" role="button">@item.Title</p>
                            </a>
                            <div class="search-results-description">
                                <a href="@Url.Action("Organization", "Metadata", new { OrganizationSeoName = @item.OrganizationSeoName() })" class="show-loading-animation" data-loading-message="Henter innhold fra @item.Organization" title="Vis alle tjenester og datasett fra @item.Organization">
                                    @if (item.Organization != null)
                                    {
                                        <p>  @item.Organization</p>
                                    }

                                </a>
                                <p>
                                    @if (item.Abstract != null)
                                    {
                                        if (item.Abstract.Length > 250)
                                        {
                                            @item.Abstract.Substring(0, 251)<text>...</text>
                                        }
                                        else
                                        {
                                            @item.Abstract
                                        }
                                    }

                                </p>
                                <p>
                                    Tilgjengelig som:
                                    <span title="Tilgjengelig som @item.DistributionType" style="width:auto" class="label label-tjeneste">@item.DistributionType</span>
                                </p>
                            </div>
                        </div>
                        <div class="col-sm-2 search-results-type">
                            <span title="@item.DistributionType" class="label label-tjeneste" style="width:auto">@item.DistributionType</span>
                        </div>
                        <div class="col-sm-3 search-results-organization">
                            <a href="@Url.Action("Organization", "Metadata", new { OrganizationSeoName = @item.OrganizationSeoName() })" class="show-loading-animation" data-loading-message="Henter innhold fra @item.Organization" title="Vis alle tjenester og datasett fra @item.Organization">
                                @if (item.Organization != null)
                                {
                                    <p>  @item.Organization</p>
                                }

                            </a>
                        </div>

                        <div class="col-sm-1 search-results-action-icons search-results-open-data">
                            @if (item.IsOpendata)
                            {
                                <span data-toggle='tooltip' data-placement='bottom' title="Åpne data" class="custom-icon custom-icon-hengelaas-open-green"></span>
                            }
                            else if (item.IsOffline)
                            {
                                <span data-toggle='tooltip' data-placement='bottom' title="Skjermede data" class="custom-icon custom-icon-hengelaas-closed-red"></span>
                            }
                            else if (item.IsRestricted)
                            {
                                <span data-toggle='tooltip' data-placement='bottom' title="Tilgangsbegrensede data" class="custom-icon custom-icon-hengelaas-closed-yellow"></span>
                            }
                        </div>

                        <div class="col-sm-2 search-results-action-buttons pull-right">

                            <button class="btn btn-copy" data-clipboard-text="@item.GetCapabilitiesUrl" alt="Kopier til utklippstavle">
                                Url til tjeneste
                            </button>
                            @if (item.ShowMapLink())
                            {
                                <a id="mapmacrolink-button-@item.Uuid" href="@Html.NorgeskartUrl()@item.DownloadUrl/" onclick="ga('send', 'event', 'Nedlasting', 'viskart');" data-toggle='tooltip' data-placement='bottom' title="" target="_blank" class="btn btn-default">
                                    <span id="mapmacro-button-@item.Uuid" class="custom-icon custom-icon-kartmarkoer"></span><span class="button-text"> Vis i kart</span>
                                </a>
                            }
                            else if (item.ShowServiceMapLink())
                            {
                                <a id="mapmacrolink-button-@item.Uuid" href="@Html.NorgeskartUrl()@item.ServiceUrl/" onclick="ga('send', 'event', 'Nedlasting', 'viskart');" data-toggle='tooltip' data-placement='bottom' title="" target="_blank" class="btn btn-default">
                                    <span id="mapmacro-button-@item.Uuid" class="custom-icon custom-icon-kartmarkoer"></span><span class="button-text"> Vis i kart</span>
                                </a>
                            }
                            else
                            {
                                <a id="mapmacrolink-button-@item.Uuid" title="Vis @item.Title i kart" class="disabled btn btn-default">
                                    <span id="mapmacro-button-@item.Uuid" class="custom-icon custom-icon-kartmarkoer"></span><span class="button-text"> Vis i kart</span>
                                </a>
                            }
                        </div>

                        <div class="col-xs-1 search-results-action-icons">
                            <span class="btn btn-copy input-group-addon" data-toggle="tooltip" data-placement="bottom" data-clipboard-text="@item.GetCapabilitiesUrl" alt="Kopier til utklippstavle" onclick="">
                                <i class="fa fa-clipboard"></i>
                            </span>
                        </div>


                        <div class="col-xs-1 search-results-action-icons action-show-map">
                            @if (item.ShowMapLink())
                            {
                                <a id="mapmacrolink-@item.Uuid" href="@Html.NorgeskartUrl()@item.DownloadUrl/" onclick="ga('send', 'event', 'Nedlasting', 'viskart');" data-toggle='tooltip' data-placement='bottom' title="@(item.IsRestrictedService() ? UI.Service_need_permission : "")" target="_blank">
                                    <span id="mapmacro-@item.Uuid" class="custom-icon @(item.IsRestrictedService() ? "custom-icon-kartmarkoer-needs-permission" : "custom-icon-kartmarkoer")"></span>
                                </a>
                            }
                            else if (item.ShowServiceMapLink())
                            {
                                <a id="mapmacrolink-@item.Uuid" href="@Html.NorgeskartUrl()@item.ServiceUrl/" onclick="ga('send', 'event', 'Nedlasting', 'viskart');" data-toggle='tooltip' data-placement='bottom' title="@(item.IsRestrictedService() ? UI.Service_need_permission : "")" target="_blank">
                                    <span id="mapmacro-@item.Uuid" class="custom-icon @(item.IsRestrictedService() ? "custom-icon-kartmarkoer-needs-permission" : "custom-icon-kartmarkoer")"></span>
                                </a>
                            }
                            else
                            {
                                <a title="Vis @item.Title i kart" class="disabled">
                                    <span class="custom-icon custom-icon-kartmarkoer"></span>
                                </a>
                            }
                        </div>
                    </div>

                    <div class="search-results-gallery-image layoutblock">
                        <div class="block shortcutpageteaserblock size-4 col-sm-4">
                            <div class="teaser-with-background-image">
                                <a href="@Url.Action("Index", "Metadata", item.ShowMetadataLinkRouteValueDictionary())">
                                    @{
                                        String thumbnailUrl = (!string.IsNullOrWhiteSpace(item.ThumbnailUrl)) ? Url.Action("Index", "Thumbnail", new { uuid = item.Uuid, type = "small" }) : "";
                                    }
                                    <div class="teaser-background-image" style="background: url(@thumbnailUrl) no-repeat center;">
                                        <div class="teaser-background-image">
                                            <div class="teaser-overlay">
                                                <div class="teaser-caption">
                                                    <div class="teaser-heading">@item.Title</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <div class="clearfix"></div>
                        </div>
                    </div>

                    <hr />
                                        }
                <div class="clearfix"></div>
            </div>

            @DisplayPaginationBottom()

                                        }
    </div>
</div>
<script>
@foreach (var item in Model.Result.Items)
{
    if (item.ShowMapLink() || item.ShowServiceMapLink())
    {
      @:getServiceStatus("@item.ServiceUuid", "@item.Uuid");
                                          }
}
        $('.btn-copy').tooltip({
            trigger: 'click',
            placement: 'bottom'
        });

        function setTooltip(btn, message) {
            btn.tooltip('hide')
              .attr('data-original-title', message)
              .tooltip('show');
        }

        function hideTooltip(btn) {
            setTimeout(function () {
                btn.tooltip('hide');
            }, 1000);
        }

    $(document).ready(function () {
        var clipboard = new Clipboard('.btn-copy');

        clipboard.on('success', function (e) {
            var btn = $(e.trigger);
            setTooltip(btn, 'Kopiert');
            hideTooltip(btn);
        });

        clipboard.on('error', function (e) {
            var btn = $(e.trigger);
            setTooltip(btn, 'Feilet!');
            hideTooltip(btn);
        });
    });
</script>
